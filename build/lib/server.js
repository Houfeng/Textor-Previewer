/*csd*/var http=require("http");var fs=require("fs");var path=require("path");var querystring=require("querystring");var url=require("url");var mimes={".html":"text/html",".htm":"text/html",".md":"text/markdown",".css":"text/css",".less":"text/less",".txt":"text/plain",".js":"text/javascript",".json":"application/x-javascript",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpeg",".gif":"image/gif",".bmp":"image/bmp",".ico":"image/x-icon","*":"application/octet-stream"};var status={"error":{code:500,message:"{0}<hr/>server error"},"success":{code:200},"notfound":{code:404,message:"{0}<hr/>not found"}};var Server=function(a){a=a||{};var c=this;c.root=a.path||"";c.port=a.port||8000;c.configFile=a.config||"/web.json";var b=c.root[c.root.length-1];if(b==="/"||b==="\\"){c.root=c.root.substr(0,c.length-1);}c.createServer();};Server.prototype.readConfig=function(a){var e=this;e.config={};try{var b=e.root+e.configFile;if(fs.existsSync(b)){var c=fs.readFileSync(b);e.config=JSON.parse(c);}}catch(d){}if(a){a();}};Server.prototype.error=function(b,c,a){if(!b||!c){return;}a=a||"";var d=this;c.writeHead(status.error.code,{"Content-Type":mimes[".html"],"url":b.url});c.end(status.error.message.replace("{0}",a.message||a));};Server.prototype.notFound=function(a,b){var c=this;b.writeHead(status.notfound.code,{"Content-Type":mimes[".html"],"url":a.url});b.end(status.notfound.message.replace("{0}",a.physicalPath));};Server.prototype.getMime=function(a){var b=this;b.config.mimes=b.config.mimes||{};return b.config.mimes[a]||mimes[a]||mimes["*"];};Server.prototype.writeFolder=function(a,b){var c=this;fs.readdir(a.physicalPath,function(e,f){var d=[];f.forEach(function(g){var h=path.normalize(a.physicalPath+"/"+g);var i=fs.statSync(h);if(i.isDirectory()){d.push('<li><a href="'+g+'/">'+g+"/</a></li>");}else{d.push('<li><a href="'+g+'">'+g+"</a></li>");}});b.writeHead(status.success.code,{"Content-Type":mimes[".html"],"url":a.url});b.end(a.url+"<hr/><ul>"+d.join("")+"</ul>");});};Server.fileParser={};Server.prototype.getParser=function(a){var c=this;c.config.parse_map=c.config.parse_map||{};c.config.parse_map[".md"]=c.config.parse_map[".md"]||"markdown";c.config.parse_map[".less"]=c.config.parse_map[".less"]||"less";c.config.parse_map[".css"]=c.config.parse_map[".css"]||"less";var b=c.config.parse_map[a];if(b){return Server.fileParser[b];}else{return null;}};Server.prototype.writeFile=function(a,b){var c=this;fs.readFile(a.physicalPath,function(e,d){var f=path.extname(a.physicalPath);var g=c.getMime(f);var h=c.getParser(f);if(h){b.writeHead(status.success.code,{"Content-Type":h.mime,"url":a.url});h.parse(d,function(i){b.end(i);});}else{b.writeHead(status.success.code,{"Content-Type":g,"url":a.url});b.end(d);}});};Server.prototype.parseFwdUrl=function(b){var c={};c.protocol=b.indexOf("https://")-1?"https://":"http://";b=b.replace("https://","").replace("http://","");var a=b.indexOf("/");if(a>-1){c.hostAndPort=b.substring(0,a);c.host=c.hostAndPort.split(":")[0]||"";c.port=c.hostAndPort.split(":")[1]||80;c.path=b.substring(a);}else{c.hostAndPort=b;c.host=c.hostAndPort.split(":")[0]||"";c.port=c.hostAndPort.split(":")[1]||80;c.path="/";}return c;};Server.prototype.forward=function(d,e,a){var f=this;d.headers.host=a.hostAndPort;d.headers.origin=a.protocol+a.hostAndPort;d.headers.referer=a.protocol+a.hostAndPort+a.path;var b=querystring.stringify(d.postData);d.headers["content-length"]=b.length;var c=http.request({host:a.host,port:a.port,path:a.path,method:d.method,headers:d.headers},function(g){e.writeHead(status.success.code,g.headers);g.on("data",function(h){e.write(h);}).on("end",function(){e.end();});}).on("error",function(g){f.error(d,e,"Remote Error : "+g.message);});c.write(b+"\n");c.end();};Server.prototype.forwardUrl=function(d,e,f){var g=this;var c=f.value;var a=g.parseFwdUrl(c);var b=d.url.split("?")[1]||"";if(b.length>0){a.path+=(a.path.indexOf("?")>-1?"&":"?")+b;}g.forward(d,e,a);};Server.prototype.forwardHost=function(c,d,e){var f=this;var b=e.value;var a=f.parseFwdUrl(b);a.path=c.url;f.forward(c,d,a);};Server.prototype.getFwdExp=function(e,b){var d=null;for(var c in b){var a=new RegExp(c);if(a.test(e)){d={"key":c,"value":b[c]};break;}}return d;};Server.prototype.handleFileSystem=function(a,b){var c=this;fs.exists(a.physicalPath,function(d){if(d){fs.stat(a.physicalPath,function(e,f){if(f.isDirectory()){c.writeFolder(a,b);}else{c.writeFile(a,b);}});}else{c.notFound(a,b);}});};Server.prototype.handleForward=function(b,c){var d=this;var e=d.getFwdExp(b.withoutQueryStringURL,d.config.fwd_url);var a=d.getFwdExp(b.withoutQueryStringURL,d.config.fwd_host);if(e){d.forwardUrl(b,c,e);}else{if(a){d.forwardHost(b,c,a);}else{d.handleFileSystem(b,c);}}};Server.prototype.handleRequest=function(b,c){var d=this;try{if(d.config.fwd_url||d.config.fwd_host){d.handleForward(b,c);}else{d.handleFileSystem(b,c);}}catch(a){d.error(b,c,a);}};Server.prototype.createServer=function(){var a=this;a.httpServer=http.createServer(function(b,c){b.postData="";b.url=decodeURI(b.url||"");b.withoutQueryStringURL=b.url.split("?")[0].split("#")[0];b.physicalPath=path.normalize(a.root+"/"+b.withoutQueryStringURL);b.addListener("data",function(d){b.postData+=d;});b.addListener("end",function(){b.postData=querystring.parse(b.postData);a.handleRequest(b,c);});});};Server.prototype.start=function(c,a){var d=this;try{d.readConfig();d.port=c||d.port;d.httpServer.listen(d.port,a);console.log("Server start on port "+d.port);}catch(b){console.log("Server start error : "+b.message);}};Server.prototype.stop=function(a){var c=this;try{c.httpServer.close(a);console.log("Server Stop.");}catch(b){console.log("Server stop error : "+b.message);}};module.exports=Server;